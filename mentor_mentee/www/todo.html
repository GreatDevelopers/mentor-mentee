{% extends "templates/web.html" %}
{% block title %}ToDo GNDEC{% endblock %}
{% block page_content %}
<div class="container mt-5">
    <h1 class="mb-4">ToDo</h1>
    {% if is_principal or is_hod or is_instructor or is_student %}
        {% if error_message %}
            <div class="alert alert-danger" role="alert">
                {{ error_message }}
            </div>
        {% endif %}
        {% if message %}
            <div class="alert alert-{{ message_type }} alert-dismissible fade show" role="alert" id="success-alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
        {% endif %}
        {% if is_principal %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Assign ToDo to HOD</h5>
                    <form method="POST" action="/todo">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <div class="form-group">
                            <label for="hod">Select HOD</label>
                            <select name="hod" id="hod" class="form-control" required>
                                <option value="">-- Select an HOD --</option>
                                {% for hod in hods %}
                                    <option value="{{ hod.user_id }}">{{ hod.employee_name }} ({{ hod.user_id }}) - {{ hod.department }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="description">ToDo Description</label>
                            <textarea name="description" id="description" class="form-control" rows="4" required placeholder="Enter task details..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select name="status" id="status" class="form-control">
                                <option value="Open" selected>Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="due_date">Due Date (Optional)</label>
                            <input type="date" name="due_date" id="due_date" class="form-control" placeholder="YYYY-MM-DD">
                        </div>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </form>
                </div>
            </div>
        {% elif is_hod %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Assign ToDo to Instructor</h5>
                    <form method="POST" action="/todo">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <div class="form-group">
                            <label for="instructor">Select Instructor</label>
                            <select name="instructor" id="instructor" class="form-control" required>
                                <option value="">-- Select an Instructor --</option>
                                {% for instructor in instructors %}
                                    <option value="{{ instructor.user_id }}">{{ instructor.employee_name }} ({{ instructor.user_id }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="description">ToDo Description</label>
                            <textarea name="description" id="description" class="form-control" rows="4" required placeholder="Enter task details..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select name="status" id="status" class="form-control">
                                <option value="Open" selected>Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="due_date">Due Date (Optional)</label>
                            <input type="date" name="due_date" id="due_date" class="form-control" placeholder="YYYY-MM-DD">
                        </div>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </form>
                </div>
            </div>
        {% elif is_instructor %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Assign ToDo to Student</h5>
                    <form method="POST" action="/todo">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <div class="form-group">
                            <label for="student">Select Student</label>
                            <select name="student" id="student" class="form-control" required>
                                <option value="">-- Select a Student --</option>
                                {% for student in students %}
                                    <option value="{{ student.name }}">{{ student.full_name }} ({{ student.name }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="description">ToDo Description</label>
                            <textarea name="description" id="description" class="form-control" rows="4" required placeholder="Enter task details..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select name="status" id="status" class="form-control">
                                <option value="Open" selected>Open</option>
                                <option value="Closed">Closed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="due_date">Due Date (Optional)</label>
                            <input type="date" name="due_date" id="due_date" class="form-control" placeholder="YYYY-MM-DD">
                        </div>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </form>
                </div>
            </div>
        {% endif %}
        <h2 class="mb-3">{{ "Assigned ToDos" if is_principal or is_hod or is_instructor else "My ToDos" }}</h2>
        <div class="mb-3 d-flex align-items-center">
            {% if is_hod %}
                <a href="/todo?show_principal_todos={{ '1' if not show_principal_todos else '0' }}{% if search %}&search={{ search }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}" class="btn btn-secondary mr-2">
                    {{ "View ToDos from Principal" if not show_principal_todos else "View Assigned ToDos" }}
                </a>
            {% elif is_instructor %}
                <a href="/todo?show_hod_todos={{ '1' if not show_hod_todos else '0' }}{% if search %}&search={{ search }}{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}" class="btn btn-secondary mr-2">
                    {{ "View ToDos from HOD" if not show_hod_todos else "View Assigned ToDos" }}
                </a>
            {% endif %}
            <div style="max-width: 300px;">
                <input type="text" id="search-input" class="form-control" placeholder="Search descriptions..." value="{{ search if search else '' }}">
            </div>
        </div>
        {% if todos %}
            <div class="table-responsive">
                <table class="table table-striped table-bordered" id="todo-table">
                    <thead class="thead-dark">
                        <tr>
                            <th>Assigned To</th>
                            <th>Assigned By</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Response</th> <!-- Response column -->
                            <th>
                                <a href="/todo?page={{ page }}{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}&sort_order={{ 'asc' if sort_order == 'desc' else 'desc' }}" style="color: white; text-decoration: none;">
                                    Date & Time {% if sort_order == 'desc' %}▼{% else %}▲{% endif %}
                                </a>
                            </th>
                            <th>Due Date</th>
                            {% if is_principal or (is_hod and not show_principal_todos) or (is_instructor and not show_hod_todos) %}
                                <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="todo-body">
                        {% for todo in todos %}
                            <tr>
                                <td>{{ todo.assigned_to_name }}</td>
                                <td>{{ todo.assigned_by_name }}</td>
                                <td>
                                    {% if todo.description|length > 50 %}
                                        <a href="#" data-toggle="modal" data-target="#descModal{{ todo.name }}">{{ todo.description[:50] }}…more</a>
                                    {% else %}
                                        {{ todo.description }}
                                    {% endif %}
                                </td>
                                <td>{{ todo.status }}</td>
                                <td>
                                    {% if todo.owner == frappe.session.user %}
                                        <div class="dropdown">
                                            <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="responseMenu{{ todo.name }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                {{ todo.custom_response }}
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="responseMenu{{ todo.name }}">
                                                <form method="POST" action="/todo" style="display:inline;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                                    <input type="hidden" name="todo_name" value="{{ todo.name }}">
                                                    <input type="hidden" name="update_response" value="1">
                                                    <input type="hidden" name="custom_response" value="">
                                                    <button type="submit" class="dropdown-item">Not Set</button>
                                                </form>
                                                <form method="POST" action="/todo" style="display:inline;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                                    <input type="hidden" name="todo_name" value="{{ todo.name }}">
                                                    <input type="hidden" name="update_response" value="1">
                                                    <input type="hidden" name="custom_response" value="Pending">
                                                    <button type="submit" class="dropdown-item">Pending</button>
                                                </form>
                                                <form method="POST" action="/todo" style="display:inline;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                                    <input type="hidden" name="todo_name" value="{{ todo.name }}">
                                                    <input type="hidden" name="update_response" value="1">
                                                    <input type="hidden" name="custom_response" value="Completed">
                                                    <button type="submit" class="dropdown-item">Completed</button>
                                                </form>
                                            </div>
                                        </div>
                                    {% else %}
                                        {{ todo.custom_response }}
                                    {% endif %}
                                </td>
                                <td>{{ todo.formatted_creation }}</td>
                                <td>{{ todo.formatted_due_date }}</td>
                                {% if is_principal or (is_hod and not show_principal_todos) or (is_instructor and not show_hod_todos) %}
                                    <td>
                                        <div class="dropdown">
                                            <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenu{{ todo.name }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                Actions
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="dropdownMenu{{ todo.name }}">
                                                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#editModal{{ todo.name }}">Edit</a>
                                                <form method="POST" action="/todo" style="display:inline;">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                                    <input type="hidden" name="todo_name" value="{{ todo.name }}">
                                                    <input type="hidden" name="delete" value="1">
                                                    <button type="submit" class="dropdown-item" onclick="return confirm('Are you sure you want to delete this ToDo?');">Delete</button>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <nav aria-label="ToDo Pagination" class="mt-3" id="pagination-nav">
                <ul class="pagination justify-content-center">
                    <li class="page-item {{ 'disabled' if page <= 1 }}">
                        <a class="page-link" href="/todo?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}" {% if page <= 1 %}tabindex="-1" aria-disabled="true"{% endif %}>Previous</a>
                    </li>
                    {% if page > 3 %}
                        <li class="page-item">
                            <a class="page-link" href="/todo?page=1{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">1</a>
                        </li>
                        {% if page > 4 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endif %}
                    {% for p in range(page - 2, page + 3) if p > 0 and p <= total_pages %}
                        <li class="page-item {{ 'active' if p == page }}">
                            <a class="page-link" href="/todo?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">{{ p }}</a>
                        </li>
                    {% endfor %}
                    {% if page < total_pages - 2 %}
                        {% if page < total_pages - 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="/todo?page={{ total_pages }}{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}">{{ total_pages }}</a>
                        </li>
                    {% endif %}
                    <li class="page-item {{ 'disabled' if page >= total_pages }}">
                        <a class="page-link" href="/todo?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}{% if sort_order %}&sort_order={{ sort_order }}{% endif %}" {% if page >= total_pages %}tabindex="-1" aria-disabled="true"{% endif %}>Next</a>
                    </li>
                </ul>
            </nav>
            <p class="text-center text-muted" id="todo-count">Showing {{ todos|length }} of {{ total_count }} ToDos (Page {{ page }} of {{ total_pages }}) {% if search %}for "{{ search }}"{% endif %}</p>
            {% for todo in todos %}
                {% if todo.description|length > 50 %}
                    <div class="modal fade" id="descModal{{ todo.name }}" tabindex="-1" role="dialog" aria-labelledby="descModalLabel{{ todo.name }}" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="descModalLabel{{ todo.name }}">Full Description</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">×</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    {{ todo.description }}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                <div class="modal fade" id="editModal{{ todo.name }}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel{{ todo.name }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editModalLabel{{ todo.name }}">Edit ToDo</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </button>
                            </div>
                            <form method="POST" action="/todo">
                                <div class="modal-body">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <input type="hidden" name="todo_name" value="{{ todo.name }}">
                                    <input type="hidden" name="edit" value="1">
                                    <input type="hidden" name="original_assignee" value="{{ todo.owner }}">
                                    <div class="form-group">
                                        <label for="edit_assignee_{{ todo.name }}">Assigned To</label>
                                        <select name="assignee" id="edit_assignee_{{ todo.name }}" class="form-control" required>
                                            <option value="">-- Select an Assignee --</option>
                                            {% if is_principal %}
                                                {% for hod in hods %}
                                                    <option value="{{ hod.user_id }}" {{ 'selected' if hod.user_id == todo.owner }}>{{ hod.employee_name }} ({{ hod.user_id }}) - {{ hod.department }}</option>
                                                {% endfor %}
                                            {% elif is_hod %}
                                                {% for instructor in instructors %}
                                                    <option value="{{ instructor.user_id }}" {{ 'selected' if instructor.user_id == todo.owner }}>{{ instructor.employee_name }} ({{ instructor.user_id }})</option>
                                                {% endfor %}
                                            {% elif is_instructor %}
                                                {% for student in students %}
                                                    <option value="{{ student.name }}" {{ 'selected' if student.name == todo.owner }}>{{ student.full_name }} ({{ student.name }})</option>
                                                {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_description_{{ todo.name }}">Description</label>
                                        <textarea name="description" id="edit_description_{{ todo.name }}" class="form-control" rows="4" required>{{ todo.description }}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_status_{{ todo.name }}">Status</label>
                                        <select name="status" id="edit_status_{{ todo.name }}" class="form-control">
                                            <option value="Open" {{ 'selected' if todo.status == 'Open' }}>Open</option>
                                            <option value="Closed" {{ 'selected' if todo.status == 'Closed' }}>Closed</option>
                                            <option value="Cancelled" {{ 'selected' if todo.status == 'Cancelled' }}>Cancelled</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit_due_date_{{ todo.name }}">Due Date (Optional)</label>
                                        <input type="date" name="due_date" id="edit_due_date_{{ todo.name }}" class="form-control" value="{{ todo.formatted_due_date if todo.formatted_due_date != 'Not Set' else '' }}">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="table-responsive">
                <table class="table table-striped table-bordered" id="todo-table">
                    <thead class="thead-dark">
                        <tr>
                            <th>Assigned To</th>
                            <th>Assigned By</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Response</th> <!-- Response column -->
                            <th>
                                <a href="/todo?page={{ page }}{% if search %}&search={{ search }}{% endif %}{% if show_principal_todos %}&show_principal_todos=1{% endif %}{% if show_hod_todos %}&show_hod_todos=1{% endif %}&sort_order={{ 'asc' if sort_order == 'desc' else 'desc' }}" style="color: white; text-decoration: none;">
                                    Date & Time {% if sort_order == 'desc' %}▼{% else %}▲{% endif %}
                                </a>
                            </th>
                            <th>Due Date</th>
                            {% if is_principal or (is_hod and not show_principal_todos) or (is_instructor and not show_hod_todos) %}
                                <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="todo-body"></tbody>
                </table>
            </div>
            <nav aria-label="ToDo Pagination" class="mt-3" id="pagination-nav"></nav>
            <p class="text-center text-muted" id="todo-count">No ToDos {{ "assigned" if is_principal or is_hod or is_instructor else "assigned to you" }} yet{% if search %} matching "{{ search }}"{% endif %}.</p>
        {% endif %}
    {% else %}
        <div class="alert alert-warning" role="alert">
            You do not have permission to access this page.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
    let currentPage = {{ page }};
    const isPrincipal = {{ "true" if is_principal else "false" }};
    const isHod = {{ "true" if is_hod else "false" }};
    const isInstructor = {{ "true" if is_instructor else "false" }};
    const isStudent = {{ "true" if is_student else "false" }};
    const csrfToken = "{{ csrf_token }}";
    const showPrincipalTodos = {{ "true" if show_principal_todos else "false" }};
    const showHodTodos = {{ "true" if show_hod_todos else "false" }};
    const hods = {{ hods | tojson | safe if is_principal else "[]" }};
    const instructors = {{ instructors | tojson | safe if is_hod else "[]" }};
    const students = {{ students | tojson | safe if is_instructor else "[]" }};
    let currentSortOrder = "{{ sort_order }}";

    // Auto-dismiss alert
    document.addEventListener("DOMContentLoaded", function() {
        const alert = document.getElementById("success-alert");
        if (alert) {
            setTimeout(() => {
                $(alert).alert("close");
            }, 5000);
        }
    });

    function updateTodos(searchTerm, page, sortOrder = currentSortOrder) {
        console.log("Searching for:", searchTerm, "Page:", page, "Sort Order:", sortOrder);
        frappe.call({
            method: "mentor_mentee.www.todo.search_todos",
            args: {
                search_term: searchTerm,
                page: page,
                sort_order: sortOrder,
                show_principal_todos: showPrincipalTodos ? "1" : "0",
                show_hod_todos: showHodTodos ? "1" : "0"
            },
            callback: function(r) {
                console.log("Response:", r.message);
                const data = r.message;
                const tbody = document.getElementById("todo-body");
                tbody.innerHTML = "";

                if (data.todos.length > 0) {
                    data.todos.forEach(todo => {
                        let row = `<tr>
                            <td>${todo.assigned_to_name}</td>
                            <td>${todo.assigned_by_name}</td>
                            <td>${todo.description.length > 50 ? 
                                `<a href="#" data-toggle="modal" data-target="#descModal${todo.name}">${todo.description.substring(0, 50)}…more</a>` : 
                                todo.description}</td>
                            <td>${todo.status}</td>
                            <td>`;
                        if (todo.owner === "{{ frappe.session.user }}") {
                            row += `<div class="dropdown">
                                <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="responseMenu${todo.name}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    ${todo.custom_response}
                                </button>
                                <div class="dropdown-menu" aria-labelledby="responseMenu${todo.name}">
                                    <form method="POST" action="/todo" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="${csrfToken}">
                                        <input type="hidden" name="todo_name" value="${todo.name}">
                                        <input type="hidden" name="update_response" value="1">
                                        <input type="hidden" name="custom_response" value="">
                                        <button type="submit" class="dropdown-item">Not Set</button>
                                    </form>
                                    <form method="POST" action="/todo" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="${csrfToken}">
                                        <input type="hidden" name="todo_name" value="${todo.name}">
                                        <input type="hidden" name="update_response" value="1">
                                        <input type="hidden" name="custom_response" value="Pending">
                                        <button type="submit" class="dropdown-item">Pending</button>
                                    </form>
                                    <form method="POST" action="/todo" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="${csrfToken}">
                                        <input type="hidden" name="todo_name" value="${todo.name}">
                                        <input type="hidden" name="update_response" value="1">
                                        <input type="hidden" name="custom_response" value="Completed">
                                        <button type="submit" class="dropdown-item">Completed</button>
                                    </form>
                                </div>
                            </div>`;
                        } else {
                            row += `${todo.custom_response}`;
                        }
                        row += `</td>
                            <td>${todo.creation}</td>
                            <td>${todo.due_date}</td>` +
                            `${isPrincipal || (isHod && !showPrincipalTodos) || (isInstructor && !showHodTodos) ? 
                                `<td>
                                    <div class="dropdown">
                                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenu${todo.name}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            Actions
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="dropdownMenu${todo.name}">
                                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#editModal${todo.name}">Edit</a>
                                            <form method="POST" action="/todo" style="display:inline;">
                                                <input type="hidden" name="csrf_token" value="${csrfToken}">
                                                <input type="hidden" name="todo_name" value="${todo.name}">
                                                <input type="hidden" name="delete" value="1">
                                                <button type="submit" class="dropdown-item" onclick="return confirm('Are you sure you want to delete this ToDo?');">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </td>` : ""}
                        </tr>`;
                        tbody.insertAdjacentHTML("beforeend", row);

                        if (todo.description.length > 50) {
                            let modal = `
                                <div class="modal fade" id="descModal${todo.name}" tabindex="-1" role="dialog" aria-labelledby="descModalLabel${todo.name}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="descModalLabel${todo.name}">Full Description</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">×</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">${todo.description}</div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                            document.body.insertAdjacentHTML("beforeend", modal);
                        }

                        let options = '';
                        if (isPrincipal) {
                            options = hods.map(hod => 
                                `<option value="${hod.user_id}" ${hod.user_id === todo.owner ? 'selected' : ''}>${hod.employee_name} (${hod.user_id}) - ${hod.department}</option>`
                            ).join('');
                        } else if (isHod) {
                            options = instructors.map(instr => 
                                `<option value="${instr.user_id}" ${instr.user_id === todo.owner ? 'selected' : ''}>${instr.employee_name} (${instr.user_id})</option>`
                            ).join('');
                        } else if (isInstructor) {
                            options = students.map(stu => 
                                `<option value="${stu.name}" ${stu.name === todo.owner ? 'selected' : ''}>${stu.full_name} (${stu.name})</option>`
                            ).join('');
                        }

                        let editModal = `
                            <div class="modal fade" id="editModal${todo.name}" tabindex="-1" role="dialog" aria-labelledby="editModalLabel${todo.name}" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editModalLabel${todo.name}">Edit ToDo</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">×</span>
                                            </button>
                                        </div>
                                        <form method="POST" action="/todo">
                                            <div class="modal-body">
                                                <input type="hidden" name="csrf_token" value="${csrfToken}">
                                                <input type="hidden" name="todo_name" value="${todo.name}">
                                                <input type="hidden" name="edit" value="1">
                                                <input type="hidden" name="original_assignee" value="${todo.owner}">
                                                <div class="form-group">
                                                    <label for="edit_assignee_${todo.name}">Assigned To</label>
                                                    <select name="assignee" id="edit_assignee_${todo.name}" class="form-control" required>
                                                        <option value="">-- Select an Assignee --</option>
                                                        ${options}
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit_description_${todo.name}">Description</label>
                                                    <textarea name="description" id="edit_description_${todo.name}" class="form-control" rows="4" required>${todo.description}</textarea>
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit_status_${todo.name}">Status</label>
                                                    <select name="status" id="edit_status_${todo.name}" class="form-control">
                                                        <option value="Open" ${todo.status === "Open" ? "selected" : ""}>Open</option>
                                                        <option value="Closed" ${todo.status === "Closed" ? "selected" : ""}>Closed</option>
                                                        <option value="Cancelled" ${todo.status === "Cancelled" ? "selected" : ""}>Cancelled</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="edit_due_date_${todo.name}">Due Date (Optional)</label>
                                                    <input type="date" name="due_date" id="edit_due_date_${todo.name}" class="form-control" value="${todo.due_date !== 'Not Set' ? todo.due_date : ''}">
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>`;
                        document.body.insertAdjacentHTML("beforeend", editModal);
                    });

                    const pagination = document.getElementById("pagination-nav");
                    let paginationHTML = `<ul class="pagination justify-content-center">`;
                    if (data.current_page > 1) {
                        paginationHTML += `<li class="page-item"><a class="page-link" href="/todo?page=${data.current_page - 1}${searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''}${showPrincipalTodos ? '&show_principal_todos=1' : ''}${showHodTodos ? '&show_hod_todos=1' : ''}&sort_order=${sortOrder}">Previous</a></li>`;
                    } else {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
                    }

                    if (data.current_page > 3) {
                        paginationHTML += `<li class="page-item"><a class="page-link" href="/todo?page=1${searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''}${showPrincipalTodos ? '&show_principal_todos=1' : ''}${showHodTodos ? '&show_hod_todos=1' : ''}&sort_order=${sortOrder}">1</a></li>`;
                        if (data.current_page > 4) {
                            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                    }

                    for (let p = Math.max(1, data.current_page - 2); p <= Math.min(data.total_pages, data.current_page + 2); p++) {
                        paginationHTML += `<li class="page-item ${p === data.current_page ? 'active' : ''}"><a class="page-link" href="/todo?page=${p}${searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''}${showPrincipalTodos ? '&show_principal_todos=1' : ''}${showHodTodos ? '&show_hod_todos=1' : ''}&sort_order=${sortOrder}">${p}</a></li>`;
                    }

                    if (data.current_page < data.total_pages - 2) {
                        if (data.current_page < data.total_pages - 3) {
                            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                        paginationHTML += `<li class="page-item"><a class="page-link" href="/todo?page=${data.total_pages}${searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''}${showPrincipalTodos ? '&show_principal_todos=1' : ''}${showHodTodos ? '&show_hod_todos=1' : ''}&sort_order=${sortOrder}">${data.total_pages}</a></li>`;
                    }

                    if (data.current_page < data.total_pages) {
                        paginationHTML += `<li class="page-item"><a class="page-link" href="/todo?page=${data.current_page + 1}${searchTerm ? '&search=' + encodeURIComponent(searchTerm) : ''}${showPrincipalTodos ? '&show_principal_todos=1' : ''}${showHodTodos ? '&show_hod_todos=1' : ''}&sort_order=${sortOrder}">Next</a></li>`;
                    } else {
                        paginationHTML += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
                    }
                    paginationHTML += `</ul>`;
                    pagination.innerHTML = paginationHTML;

                    document.getElementById("todo-count").innerHTML = `Showing ${data.todos.length} of ${data.total_count} ToDos (Page ${data.current_page} of ${data.total_pages})${searchTerm ? ' for "' + searchTerm + '"' : ''}`;
                } else {
                    tbody.innerHTML = "";
                    document.getElementById("pagination-nav").innerHTML = "";
                    document.getElementById("todo-count").innerHTML = `No ToDos ${isPrincipal || isHod || isInstructor ? "assigned" : "assigned to you"} yet${searchTerm ? ' matching "' + searchTerm + '"' : ''}.`;
                }
            }
        });
    }

    document.getElementById("search-input").addEventListener("input", function(e) {
        const searchTerm = e.target.value.trim();
        currentPage = 1;
        updateTodos(searchTerm, currentPage);
    });
</script>
{% endblock %}
